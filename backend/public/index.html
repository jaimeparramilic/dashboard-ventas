<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard de Ventas - ODDS</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
  --bg:#000; --card:#0f172a; --muted:#9ca3af; --border:#374151; --txt:#fff;
  --gap:12px; --radius:12px;
  --shadow:0 8px 28px rgba(0,0,0,.45);
  --shadow-soft:0 4px 18px rgba(0,0,0,.35);
  --control-h:42px;                 /* alto táctil base móvil */
  --fs-title:clamp(16px, 2.6vw, 20px);
  --fs-kpi:clamp(18px, 4.2vw, 24px);
  --fs-label:clamp(11px, 1.8vw, 13px);
  --fs-body:clamp(13px, 2.4vw, 15px);
}

html, body{ height:100%; }
body{
  background:var(--bg); color:var(--txt);
  font-family:'Segoe UI',system-ui,-apple-system,Arial,sans-serif;
  font-size:var(--fs-body);
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}

/* Header STICKY (no fixed) + safe area iOS */
.topbar{
  position: sticky; top: 0; z-index: 1000;
  background:#111; border-bottom:1px solid #222; padding:4px 0;
  padding-top: calc(4px + env(safe-area-inset-top));
}
.brand img{ height:34px; }
.brand-title{ font-weight:800; font-size:var(--fs-title); margin:0 0 0 .5rem; }

/* -------- Filtros (mobile-first) -------- */
.filters-wrap{ padding:8px 0 6px; }
.filters-wrap .row{ row-gap:10px; }  /* más aire entre campos en móvil */
.form-label{ font-size:var(--fs-label); color:#cbd5e1; margin-bottom:4px; }
.form-select, .btn{
  background:#1b1b1b; color:#fff; border:1px solid #3a3a3a;
  font-size:var(--fs-body); padding:.35rem .6rem; height:var(--control-h);
  border-radius:10px;
}
.btn-apply{ background:#fff; color:#000; font-weight:700; border:none; }
.btn-outline-light{ border-color:#666; color:#ddd; }
.btn-outline-light:hover{ background:#ddd; color:#111; }

/* Toggle nivel */
.btn-seg{ background:#1f2937; color:#e5e7eb; border:1px solid #374151; font-weight:600; }
.btn-seg.active{ background:#fff; color:#111827; border-color:#fff; }
.btn-seg:not(.active):hover{ filter:brightness(1.08); }

/* -------- KPI cards — horizontales + carrusel móvil -------- */
#kpiContainer{
  display:flex !important; gap:12px; align-items:stretch;
  flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling: touch;
  padding: 6px 2px 8px; position:relative; z-index:5;
  margin-top:12px !important; margin-bottom:8px !important;
  scroll-snap-type:x mandatory;
}
#kpiContainer > .col{
  flex: 0 0 82vw;                 /* ~80% del viewport en móvil */
  min-width: 260px; min-height: 88px;
  scroll-snap-align:start;
}
.kpi-card{
  background:#121826 !important; border:1px solid #374151 !important;
  border-radius:var(--radius) !important; padding:12px 14px !important;
  box-shadow:var(--shadow-soft) !important;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
}
.kpi-card h6{
  color:#9ca3af !important; margin:0 !important; font-size:var(--fs-label) !important;
  text-transform:uppercase; letter-spacing:.4px; line-height:1.15; white-space:nowrap;
}
.kpi-card p{
  margin:0 !important; font-weight:800 !important; font-size:var(--fs-kpi) !important;
  line-height:1; white-space:nowrap;
}

/* -------- Mapa -------- */
#map{
  height:58vh; /* móvil: deja espacio para KPIs/filtros */
  border-radius:12px; border:1px solid var(--border);
  background:#000; box-shadow:var(--shadow); margin-top:10px;
  position:relative; z-index:0;
}
.poly-glow{ filter: drop-shadow(0 0 10px rgba(139,92,246,.35)); }

/* Leaflet */
#map, .leaflet-container{ overflow:visible !important; }
.leaflet-control{ z-index:10000 !important; }
.leaflet-bottom.leaflet-right{ right:10px; bottom:10px; }
.leaflet-control-zoom a{ width:34px; height:34px; line-height:34px; }

/* -------- Gráfica -------- */
.card-time{
  background:#111; border:1px solid #444; border-radius:12px; box-shadow:0 8px 28px rgba(0,0,0,.4);
  margin-top:12px;
}
#chartVentas{ display:block; width:100% !important; height:280px !important; } /* móvil */
canvas{ background:#111; border-radius:10px; padding:10px; width:100%; }

/* -------- Accesibilidad / Motion -------- */
@media (prefers-reduced-motion: reduce){
  *{ animation: none !important; transition: none !important; }
}

/* ================== Breakpoints ================== */

/* ≥ 576px (SM): 2 KPIs por fila, mapa/gráfica un poco más altos */
@media (min-width:576px){
  :root{ --control-h:44px; }
  #kpiContainer{ overflow-x:visible; flex-wrap:wrap; }
  #kpiContainer > .col{ flex: 1 1 calc((100% - var(--gap)) / 2); min-width: 0; }
  #map{ height:62vh; }
  #chartVentas{ height:320px !important; }
}

/* ≥ 768px (MD): controles más grandes y botones de nivel en una línea */
@media (min-width:768px){
  :root{ --control-h:46px; }
  .form-select, .btn{ border-radius:12px; }
  #map{ height:66vh; }
  #chartVentas{ height:360px !important; }
}

/* ≥ 992px (LG): 3 KPIs por fila, layout más “desktop” */
@media (min-width:992px){
  :root{ --gap:14px; }
  #kpiContainer{ flex-wrap:wrap; gap:14px; }
  #kpiContainer > .col{ flex: 1 1 calc((100% - (var(--gap)*2)) / 3); min-width:0; }
  .kpi-card{ padding-left: 20px !important;
  padding-right: 20px !important; }
  #map{ height:72vh; }
  #chartVentas{ height:400px !important; }
}

/* ≥ 1200px (XL): tipografías un poco más grandes en KPIs */
@media (min-width:1200px){
  .kpi-card p{ font-size: clamp(22px, 2vw, 26px) !important; letter-spacing:.2px; }
}

/* ≥ 1400px (XXL): listo para 4 KPIs si agregas una cuarta card */
@media (min-width:1400px){
  #kpiContainer > .col{ flex: 1 1 calc((100% - (var(--gap)*3)) / 4); }
}

/* Deja que el dedo desplace la página sobre el mapa (Leaflet pone touch-action:none) */
#map.leaflet-container,
#map .leaflet-container{
  touch-action: pan-y !important; /* desplaza vertical; evita “agarre” agresivo del mapa */
}


  </style>
</head>

<body>
  
  <!-- TOP BAR (sticky) -->
  <header class="topbar">
    <div class="container">
      <!-- Logo + título -->
      <div class="d-flex align-items-center">
        <a class="brand d-flex align-items-center text-decoration-none text-white" href="#">
          <img src="logo_odds.png" alt="ODDS">
          <span class="brand-title">Dashboard de Ventas</span>
        </a>
      </div>

      <!-- Filtros (en una sola línea) + Nivel + Acciones -->
      <div class="filters-wrap">
        <div class="row g-2 align-items-end">
          <div class="col-6 col-xxl-2">
            <label for="departamento" class="form-label">Departamento</label>
            <select id="departamento" class="form-select"><option value="">Todas</option></select>
          </div>
          <div class="col-6 col-xxl-2">
            <label for="ciudad" class="form-label">Ciudad</label>
            <select id="ciudad" class="form-select"><option value="">Todas</option></select>
          </div>
          <div class="col-6 col-xxl-2">
            <label for="macrocategoria" class="form-label">Macrocategoría</label>
            <select id="macrocategoria" class="form-select"><option value="">Todas</option></select>
          </div>
          <div class="col-6 col-xxl-2">
            <label for="categoria" class="form-label">Categoría</label>
            <select id="categoria" class="form-select"><option value="">Todas</option></select>
          </div>
          <div class="col-6 col-xxl-2">
            <label for="subcategoria" class="form-label">Subcategoría</label>
            <select id="subcategoria" class="form-select"><option value="">Todas</option></select>
          </div>
          <div class="col-6 col-xxl-2">
            <label for="marca" class="form-label">Marca</label>
            <select id="marca" class="form-select"><option value="">Todas</option></select>
          </div>

          <!-- NUEVO: Inversión en medios -->
          
        <div class="col-6 col-xxl-2">
          <label for="inv_meta" class="form-label">Inversión Meta (Millones de COP)</label>
          <input id="inv_meta" type="number" step="any" min="0" class="form-select" placeholder="0" />
        </div>
        <div class="col-6 col-xxl-2">
          <label for="inv_google" class="form-label">Inversión Google (Millones de COP)</label>
          <input id="inv_google" type="number" step="any" min="0" class="form-select" placeholder="0" />
        </div>


          <!-- Nivel -->
          <div class="col-12 col-lg-5 col-xxl-4">
            <label class="form-label">Nivel</label>
            <div id="nivelGroup" class="btn-group w-100" role="group" aria-label="Nivel">
              <button id="nivel-departamento" type="button" class="btn btn-seg active" data-nivel="departamento" onclick="changeNivel('departamento')">Departamento</button>
              <button id="nivel-ciudad" type="button" class="btn btn-seg" data-nivel="ciudad" onclick="changeNivel('ciudad')">Ciudad</button>
            </div>
          </div>

          <!-- Acciones -->
          <div class="col-6 col-lg-3 col-xxl-2 d-grid">
            <label class="form-label d-none d-lg-block">&nbsp;</label>
            <button id="btnMapa" class="btn btn-apply" onclick="aplicar()">Aplicar</button>
          </div>
          <div class="col-6 col-lg-2 col-xxl-2 d-grid">
            <label class="form-label d-none d-lg-block">&nbsp;</label>
            <button id="btnExport" class="btn btn-outline-light" onclick="exportarCSV()">Descargar CSV</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- CONTENIDO (ya no se necesita spacer) -->
  <main class="container py-2">
    <!-- KPIs -->
    <!-- KPIs -->
<div id="kpiContainer" class="row row-cols-1 row-cols-md-3 g-3 text-center mb-2" style="position:relative;z-index:5;">
  <div class="col">
    <div class="kpi-card h-100 p-3" style="background:#121826;border:1px solid #374151;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,.35);">
      <h6 class="mb-1" style="color:#9ca3af;text-transform:uppercase;letter-spacing:.4px;">Total Ventas</h6>
      <p id="kpi-ventas" class="m-0 fw-bold" style="font-size:1.35rem;">--</p>
    </div>
  </div>
  <div class="col">
    <div class="kpi-card h-100 p-3" style="background:#121826;border:1px solid #374151;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,.35);">
      <h6 class="mb-1" style="color:#9ca3af;text-transform:uppercase;letter-spacing:.4px;">Unidades Vendidas</h6>
      <p id="kpi-unidades" class="m-0 fw-bold" style="font-size:1.35rem;">--</p>
    </div>
  </div>
  <div class="col">
    <div class="kpi-card h-100 p-3" style="background:#121826;border:1px solid #374151;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,.35);">
      <h6 class="mb-1" style="color:#9ca3af;text-transform:uppercase;letter-spacing:.4px;">Ticket Promedio</h6>
      <p id="kpi-ticket" class="m-0 fw-bold" style="font-size:1.35rem;">--</p>
    </div>
  </div>
</div>


    <!-- Mapa -->
    <div id="map"></div>

    <!-- Serie de tiempo -->
    <div class="card card-time mt-3 p-3">
      <canvas id="chartVentas"></canvas>
    </div>
  </main>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Tu app -->
  <script type="module" src="/js/main.js"></script>

  <!-- Helpers inline (nivel/mapa) -->
  <script>
    function changeNivel(nuevo) {
      try {
        if (!window.nivelMapa) window.nivelMapa = 'departamento';
        if (nuevo === window.nivelMapa) return;
        window.nivelMapa = nuevo;

        const group = document.getElementById('nivelGroup');
        if (group) {
          group.querySelectorAll('button').forEach(b => b.classList.remove('active'));
          const btn = group.querySelector(`button[data-nivel="${nuevo}"]`);
          if (btn) btn.classList.add('active');
        }
        if (typeof renderCoropletas === 'function') renderCoropletas();
        if (typeof cargarKPIs === 'function') cargarKPIs();
        if (typeof cargarGrafico === 'function') cargarGrafico();
      } catch (e) { console.error(e); }
    }
    function aplicar() {
      if (typeof cargarKPIs === 'function') cargarKPIs();
      if (typeof renderCoropletas === 'function') renderCoropletas();
      if (typeof cargarGrafico === 'function') cargarGrafico();
    }
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(console.error);
    }
  </script>

  <script>
  // Evita que la rueda haga zoom del mapa a menos que se mantenga Ctrl/⌘.
  // Deja pasar el evento al navegador para que SIGA scrolleando la página.
  window.addEventListener('load', () => {
    const el = document.getElementById('map');
    if (!el) return;

    // Intercepta la rueda: no hacemos preventDefault, así la página sigue desplazándose.
    el.addEventListener('wheel', (e) => {
      if (!(e.ctrlKey || e.metaKey)) {
        e.stopPropagation(); // evita que Leaflet reciba la rueda (no zoom)
      }
    }, { passive: true });

    // (Opcional) un “hint” para el usuario
    const hint = document.createElement('div');
    hint.textContent = 'Mantén Ctrl (o ⌘) y usa la rueda para hacer zoom';
    Object.assign(hint.style, {
      position: 'absolute', left: '50%', bottom: '12px', transform: 'translateX(-50%)',
      background: 'rgba(17,24,39,.92)', color: '#fff', padding: '6px 10px',
      borderRadius: '10px', fontSize: '12px', lineHeight: 1.2, pointerEvents: 'none',
      opacity: '0', transition: 'opacity 150ms ease', zIndex: '10000'
    });
    // El #map ya es position:relative en tu CSS; si no, forzamos:
    const mapWrap = document.getElementById('map');
    if (getComputedStyle(mapWrap).position === 'static') mapWrap.style.position = 'relative';
    mapWrap.appendChild(hint);

    let hideTO;
    el.addEventListener('wheel', (e) => {
      if (!(e.ctrlKey || e.metaKey)) {
        hint.style.opacity = '1';
        clearTimeout(hideTO);
        hideTO = setTimeout(() => { hint.style.opacity = '0'; }, 1200);
      } else {
        hint.style.opacity = '0';
      }
    }, { passive: true });
  });
</script>

</body>
</html>
